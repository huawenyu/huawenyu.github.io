---
layout: post
title:  "sniffer"
date:   2014-02-16 13:31:01 +0800
categories: linux
tags: network
---

* content
{:toc}


# Install

    $ sudo apt-get install wireshark
    $ sudo apt-get install tshark
    $ sudo apt-get install ngrep
    $ sudo apt-get install httpry

# ngrep

    $ sudo apt-get install ngrep

    $ ngrep [options] pattern [filter]

    * if pattern = '': means match anything

    $ sudo ngrep -q -d eth1 ''  'src host 10.1.1.129 and port 80'

## capture to file

```
    # ngrep -O /tmp/dns.dump -d any -T port domain
        interface: any
        filter: ip and ( port domain )
        output: /tmp/dns.dump

    # ngrep -I /tmp/dns.dump port 80
        input: /tmp/dns.dump
        filter: ip and ( port 80 )

```

## protocol

    $ ngrep -q 'HTTP' 'tcp'
    $ ngrep -q 'HTTP' 'udp'
    $ ngrep -q 'HTTP' 'icmp'

## filter

    $ ngrep -q 'HTTP' 'host 192.168'
    $ ngrep -q 'HTTP' 'dst host 192.168'
    $ ngrep -q 'HTTP' 'port 80'

    ### only filter working
    $ ngrep -q '' -e 'host xx.xx.xxx.170 and not udp port 22'

## content match

```
    $ ngrep -t '^(GET|POST) ' 'src host 12.13.14.15 and tcp and dst port 80'

        The caret (^) instructs ngrep to only look at the beginning of the packet payload. As above, the (...|...) will match
        either GET or POST. Ngrep will show just the actual web requests:

    $ ngrep -t '^(GET|POST) ' 'src host 12.13.14.15 and tcp and dst port 80'

        interface: eth0 (12.13.14.0/255.255.255.0)
        filter: ip and ( src host 12.13.14.15 and tcp and dst port 80 )
        match: ^(GET|POST)


    $ ngrep -t '' 'tcp and port 80'

    $ ngrep -t '^(GET|POST|HEAD) ' 'dst host 67.207.152.20 and tcp and dst port 80' -W byline

        interface: wlan0 (192.168.1.0/255.255.255.0)
        filter: (ip or ip6) and ( dst host 67.207.152.20 and tcp and dst port 80 )
        match: ^(GET|POST|HEAD) 

        ###
        T 2015/06/11 12:11:07.697041 192.168.1.15:34153 -> 67.207.152.20:80 [AP]
        HEAD / HTTP/1.1.
        User-Agent: curl/7.35.0.
        Host: xtof.ch.
        Accept: */*.
        .

        ###
```

## Sample

```
    $ sudo ngrep port 80

        interface: wlp3s0 (192.168.0.0/255.255.255.0)
        filter: (ip or ip6) and ( port 80 )
        ######
        T 192.168.0.121:43314 -> 198.167.239.174:80 [AP]
          GET / HTTP/1.1..Host: www.tired.com..User-Agent: curl/7.47.0..Accept: */*....
        ##
        T 198.167.239.174:80 -> 192.168.0.121:43314 [AP]
          HTTP/1.1 200 OK..Date: Thu, 06 Apr 2017 06:01:00 GMT..Server: Apache/2.2.16 (Debian)..Last-Modified: Mon, 29 Sep 2003 08:34:25 GMT.
          .ETag: "3d7130-b8-3c873c3fc0640"..Accept-Ranges: bytes..Content-Length: 184..Vary: Accept-Encoding..Content-Type: text/html..X-Pad:
           avoid browser bug....<HTML>.<HEAD>.<TITLE>Are you tired?</TITLE>.</HEAD>.<BODY BGCOLOR=#FFFFFF>.<PRE>.<CENTER>....Are you tired?..
          Tell <a href="mailto:tired@tired.com">us</a> why..</CENTER>.</PRE>.</BODY>.
        ####


    $ sudo ngrep -W byline port 80

        interface: wlp3s0 (192.168.0.0/255.255.255.0)
        filter: (ip or ip6) and ( port 80 )
        ####
        T 192.168.0.121:43318 -> 198.167.239.174:80 [AP]
        GET / HTTP/1.1.
        Host: www.tired.com.
        User-Agent: curl/7.47.0.
        Accept: */*.
        .

        ##
        T 198.167.239.174:80 -> 192.168.0.121:43318 [AP]
        HTTP/1.1 200 OK.
        Date: Thu, 06 Apr 2017 06:03:04 GMT.
        Server: Apache/2.2.16 (Debian).
        Last-Modified: Mon, 29 Sep 2003 08:34:25 GMT.
        ETag: "3d7130-b8-3c873c3fc0640".
        Accept-Ranges: bytes.
        Content-Length: 184.
        Vary: Accept-Encoding.
        Content-Type: text/html.
        X-Pad: avoid browser bug.
        .
        <HTML>
        <HEAD>
        <TITLE>Are you tired?</TITLE>
        </HEAD>
        <BODY BGCOLOR=#FFFFFF>
        <PRE>
        <CENTER>

        Are you tired?

        Tell <a href="mailto:tired@tired.com">us</a> why.
        </CENTER>
        </PRE>
        </BODY>

        ####
```

# httpry

    $ sudo apt install httpry

    $ sudo httpry -i eth0
    $ sudo httpry -i eth0 'host 192.168.5.25'

    $ sudo httpry -i eth0 -b output.dump    # save raw HTTP packets into a binary file
    $ httpry -r output.dump                 # replay saved HTTP packets

    $ sudo httpry -i eth0 -o output.txt     # save httpry's output to a text file
    $ sudo httpry -i eth0 -m get,head

# tshark

## list interfaces

    > $ tshark -D
    > tshark: There are no interfaces on which a capture can be done

    $ sudo tshark -D            # et a list of the available network interfaces
    1. eth0
    2. nflog (Linux netfilter log (NFLOG) interface)
    3. any (Pseudo-device that captures on all interfaces)
    4. lo

## capture

    $ tshark -i eth0
    $ tshark -i eth0 -c 500 -w /tmp/http-test.pcap      # capture-to file
    $ tshark -r /tmp/http-test.pcap                     # view content of capture-file

### capture with protocol

    $ tshark -i eth0 -Y "http"
    $ tshark -i eth0 -Y "icmp"

## search from capture

    $ tshark -r nmap.pcap -R "ip.src == 2.x.yy.6 || ip.dst == 2.x.yy.6"
    $ tshark -q -r http.pcap -R http -z http,tree
    $ tshark -r nmap.pcap -R "icmp"

## filter

    $ tshark -w /tmp/dhcp.pcap -f "port 67 or port 68" -i eth1 -P
        -f "host 192.168.1.100 and (dst port 53 or 80)"
        -f "not broadcast and not multicast"
        -f "http.response.code == 404 && ip.addr == 192.168.10.1"
        -f "tcp.port == 25"
        -Y "ip.addr==192.168.1.1"
        -Y "tcp.port== 8800 and http.request"
        -Y "not arp or icmp"
        -d udp.port==8472,vxlan -r 1.cap "tcp.analysis.duplicate_ack_num==1"

    $ tshark -r /tmp/dhcp.pcap bootp.option.dhcp == 1
    $ tshark -r ~/dhcp.pcap -V frame.number == 1        # view content of a single packet

## formatting

    $ tshark -i eth2 -O  icmp
        -V verbose and display details about packets
        -O like the -V option, however this will show details of a specific protocol

## list of IP conversations

    $ tshark -r cap.pcap -z conv,ip


  [1]: https://sourceware.org/gdb/onlinedocs/gdb/gdbserver-man.html
  [2]: https://sourceware.org/gdb/wiki/FAQ
  [3]: https://blogs.oracle.com/ksplice/entry/8_gdb_tricks_you_should
  [4]: http://sourceware.org/gdb/onlinedocs/gdb/Continuing-and-Stepping.html
  [5]: https://github.com/huawenyu/neogdb.vim
