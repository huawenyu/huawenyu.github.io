---
layout: post
title:  "network: ip-tools"
date:   2014-02-16 13:31:01 +0800
categories: linux
tags: network
---

* content
{:toc}


# Quick Start

## ip tools

    # ip link show
    # ip link set dev eth0 up
    # ip addr show dev lan
    # ip addr flush dev lan                     #清空网卡的所有ip地址
    # ip addr add 192.168.2.77/24 dev lan       #添加ip
    # ip neigh show                             #显示ip与mac对应关系
    # ip neigh flush dev lan
    # ip route
    # ip route add 192.168.2.0/24 via 192.168.1.1 dev1234
    # ip route change default via 10.10.10.30 dev wan
    # traceroute www.google.com

## ss

    $ ss -t4 state established           <<<< To display all Ipv4 tcp sockets that are in "connected" state.

    ### Since sockets remain in such states syn-sent, syn-recv for a very short time.
    ###   It would be ideal to use the watch command to detect such socket states in real time.
    $ watch -n 1 "ss -t4 state syn-sent"

    $ ss -at '( dport = :ssh or sport = :ssh )'    <<< Display all socket connections with source or destination port of ssh.
    $ ss -nt '( dst :443 or dst :80 )'   <<< Option -n donnot resolve hostname|domain-name
    <OR> $ ss -nt dst :443 or dst :80    <<< Sockets with destination port 443 or 80
    $ ss -nt dst 74.125.236.178          <<< Filter by address
    $ ss -nt dst 74.125.236.178/16       <<< CIDR notation is also supported
    $ ss -nt dst 74.125.236.178:80       <<< Address and Port combined

## netstat

    # netstat -a        <List All Ports (both listening and non listening ports)>
    # netstat -l        <Active Internet connections>
    # netstat -s        <Show statistics for all ports>
    # netstat -pt       <Show the PID/Program Name>

# netstat

## command of `netstat`

### (-a) List ports by protocol

    # netstat -a | more <---List All Ports (both listening and non listening ports)
    # netstat -at       <---List all tcp ports
    # netstat -au       <---List all udp ports

### (-l) List by state=Listening

    # netstat -l
    # netstat -lt
    # netstat -lu       <Active Internet connections>
    # netstat -lx       <Active UNIX domain sockets>

### (-s) Show the statistics for each protocol

    # netstat -s        <Show statistics for all ports>
    # netstat -st       <Show statistics for TCP (or) UDP ports>
    # netstat -su

### (-p) Display PID and program names

    # netstat -pt       <Show the PID/Program Name>

### (-n) Disable resolve host

- This will display in numbers, instead of resolving the host name, port name, user name.
- Also speeds up the output, as netstat is not performing any look-up.

### (-c) Auto refresh list

### (--verbose) Find the non supportive Address families in your system

### (-r) Display the kernel routing information

### (-i, -ie) Show the list of network interfaces

## sample output

### netstat -a | more

      Active Internet connections (servers and established)
      Proto Recv-Q Send-Q Local Address           Foreign Address         State
      tcp        0      0 localhost:30037         *:*                     LISTEN
      udp        0      0 *:bootpc                *:*

      Active UNIX domain sockets (servers and established)
      Proto RefCnt Flags       Type       State         I-Node   Path
      unix  2      [ ACC ]     STREAM     LISTENING     6135     /tmp/.X11-unix/X0
      unix  2      [ ACC ]     STREAM     LISTENING     5140     /var/run/acpid.socket


    # netstat -at

      Active Internet connections (servers and established)
      Proto Recv-Q Send-Q Local Address           Foreign Address         State
      tcp        0      0 localhost:30037         *:*                     LISTEN
      tcp        0      0 localhost:ipp           *:*                     LISTEN
      tcp        0      0 *:smtp                  *:*                     LISTEN
      tcp6       0      0 localhost:ipp           [::]:*                  LISTEN


    # netstat -au

      Active Internet connections (servers and established)
      Proto Recv-Q Send-Q Local Address           Foreign Address         State
      udp        0      0 *:bootpc                *:*
      udp        0      0 *:49119                 *:*
      udp        0      0 *:mdns                  *:*


### netstat -l

      Active Internet connections (only servers)
      Proto Recv-Q Send-Q Local Address           Foreign Address         State
      tcp        0      0 localhost:ipp           *:*                     LISTEN
      tcp6       0      0 localhost:ipp           [::]:*                  LISTEN
      udp        0      0 *:49119                 *:*
      List only listening TCP Ports using netstat -lt

    # netstat -lt

      Active Internet connections (only servers)
      Proto Recv-Q Send-Q Local Address           Foreign Address         State
      tcp        0      0 localhost:30037         *:*                     LISTEN
      tcp        0      0 *:smtp                  *:*                     LISTEN
      tcp6       0      0 localhost:ipp           [::]:*                  LISTEN
      List only listening UDP Ports using netstat -lu

    # netstat -lu

      Active Internet connections (only servers)
      Proto Recv-Q Send-Q Local Address           Foreign Address         State
      udp        0      0 *:49119                 *:*
      udp        0      0 *:mdns                  *:*
      List only the listening UNIX Ports using netstat -lx

    # netstat -lx

      Active UNIX domain sockets (only servers)
      Proto RefCnt Flags       Type       State         I-Node   Path
      unix  2      [ ACC ]     STREAM     LISTENING     6294     private/maildrop
      unix  2      [ ACC ]     STREAM     LISTENING     6203     public/cleanup
      unix  2      [ ACC ]     STREAM     LISTENING     6302     private/ifmail
      unix  2      [ ACC ]     STREAM     LISTENING     6306     private/bsmtp

### netstat -s

      Ip:
          11150 total packets received
          1 with invalid addresses
          0 forwarded
          0 incoming packets discarded
          11149 incoming packets delivered
          11635 requests sent out
      Icmp:
          0 ICMP messages received
          0 input ICMP message failed.
      Tcp:
          582 active connections openings
          2 failed connection attempts
          25 connection resets received
      Udp:
          1183 packets received
          4 packets to unknown port received.
      .....


    ### netstat -p option can be combined with any other netstat option.
    ###   This will add the “PID/Program Name” to the netstat output. This is very useful while debugging to identify which program is running on a particular port.

### netstat -pt

      Active Internet connections (w/o servers)
      Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
      tcp        1      0 ramesh-laptop.loc:47212 192.168.185.75:www        CLOSE_WAIT  2109/firefox
      tcp        0      0 ramesh-laptop.loc:52750 lax:www ESTABLISHED 2109/firefox


    # netstat -an

    ### If you don’t want only any one of those three items ( ports, or hosts, or users ) to be resolved, use following commands.
    # netsat -a --numeric-ports
    # netsat -a --numeric-hosts
    # netsat -a --numeric-users


    ### netstat will print information continuously every few seconds.

### netstat -c

      Active Internet connections (w/o servers)
      Proto Recv-Q Send-Q Local Address           Foreign Address         State
      tcp        0      0 ramesh-laptop.loc:36130 101-101-181-225.ama:www ESTABLISHED
      tcp        1      1 ramesh-laptop.loc:52564 101.11.169.230:www      CLOSING
      tcp        0      0 ramesh-laptop.loc:43758 server-101-101-43-2:www ESTABLISHED
      tcp        1      1 ramesh-laptop.loc:42367 101.101.34.101:www      CLOSING
      ^C

    ### Find the non supportive Address families in your system

### netstat --verbose

    At the end, you will have something like this.

    netstat: no support for `AF IPX' on this system.
    netstat: no support for `AF AX25' on this system.
    netstat: no support for `AF X25' on this system.
    netstat: no support for `AF NETROM' on this system.

### netstat -r
Display the kernel routing information using netstat -r

      Kernel IP routing table
      Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
      192.168.1.0     *               255.255.255.0   U         0 0          0 eth2
      link-local      *               255.255.0.0     U         0 0          0 eth2
      default         192.168.1.1     0.0.0.0         UG        0 0          0 eth2
      Note: Use netstat -rn to display routes in numeric format without resolving for host-names.

### netstat -i
Show the list of network interfaces

      Kernel Interface table
      Iface   MTU Met   RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
      eth0       1500 0         0      0      0 0             0      0      0      0 BMU
      eth2       1500 0     26196      0      0 0         26883      6      0      0 BMRU
      lo        16436 0         4      0      0 0             4      0      0      0 LRU

    ### Display extended information on the interfaces (similar to ifconfig) using netstat -ie:
    # netstat -ie

      Kernel Interface table
      eth0      Link encap:Ethernet  HWaddr 00:10:40:11:11:11
                UP BROADCAST MULTICAST  MTU:1500  Metric:1
                RX packets:0 errors:0 dropped:0 overruns:0 frame:0
                TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
                collisions:0 txqueuelen:1000
                RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
                Memory:f6ae0000-f6b00000

# ss: a substitution of netstat

    ss -t -a dumps all TCP sockets
    ss -u -a dumps all UDP sockets
    ss -w -a dumps all RAW sockets
    ss -x -a dumps all UNIX sockets

    Option -o shows TCP timers state.
    Option -e shows some extended information.

## filter by socket states

    $ ss (action: state|exclude) <state>

F.e. to dump all tcp sockets except SYN-RECV:

    $ ss exclude SYN-RECV

- all - for all the states
- bucket - for TCP minisockets (TIME-WAIT|SYN-RECV)
- big - all except for minisockets
- connected - not closed and not listening
- synchronized - connected and not SYN-SENT

If neither state nor exclude directives are present, state filter defaults to all with option -a or to all, excluding:
listening, syn-recv, time-wait and closed sockets.

some state identifier. abbreviations:

  1. established 
  2. syn-sent 
  3. syn-recv 
  4. fin-wait-1 
  5. fin-wait-2 
  6. time-wait 
  7. closed 
  8. close-wait 
  9. last-ack 
  10. closing 
  11. all - All of the above states 
  12. connected - All the states except for listen and closed 
  13. synchronized - All the connected states except for syn-sent 
  14. bucket - Show states, which are maintained as minisockets, i.e. time-wait and syn-recv. 
  15. big - Opposite to bucket state.


### Samples

1) List all the tcp sockets in state FIN-WAIT-1 for our apache to network 193.233.7/24 and look at their timers:

    $ ss -o state fin-wait-1 \( sport = :http or sport = :https \) \
                          dst 193.233.7/24

Oops, forgot to say that missing logical operation is equivalent to and.

2) Well, now look at the rest...

    $ ss -o excl fin-wait-1
    $ ss state fin-wait-1 \( sport neq :http and sport neq :https \) \
                       or not dst 193.233.7/24

Note that we have to do `two` calls of ss to do this. State match is always anded to address/port match.
The reason for this is purely technical:
  - ss does fast skip of not matching states before parsing addresses 
  - and I consider the ability to skip fastly gobs of time-wait and syn-recv sockets as more important than logical generality.

3) So, let's look at all our sockets using autobound ports:

    $ ss -a -A all autobound

4) And eventually find all the local processes connected to local X servers:

    $ ss -xp dst "/tmp/.X11-unix/*"

Pardon, this does not work with current kernel, patching is required. But we still can look at server side:

    $ ss -x src "/tmp/.X11-unix/*"

# iproute

    # rpm -qf $(which ip)

      iproute-2.6.18-9.el5

从某种意义上说，iproute工具集几乎可以替代掉net-tools工具集，具体的替代方案是这样的：
```
     用途        net-tool（被淘汰） iproute2
  -----------------------------------------------
  地址和链路配置 ifconfig           ip-addr,ip-link
  路由表         route              ip-route
  邻居           arp                ip-neigh
  VLAN           vconfig            ip-link
  隧道           iptunnel           ip-tunnel
  组播           ipmaddr            ip-maddr
  统计           netstat            ss
```

## IP tools

- ip link set--改变设备的属性
- ip link show--显示设备属性
- ip address add--添加一个新的协议地址
- ip address delete--删除一个协议地址.
- ip address show--显示协议地址
- ip address flush--清除协议地址
- ip neighbour show --neighbour/arp表管理命令
- ip neighbour add -- 添加一个新的邻接条目
- ip neighbour change--修改一个现有的条目
- ip neighbour replace--替换一个已有的条目
- ip route show --路由
- ip route add -- 添加新路由
- ip route change -- 修改路由
- ip route replace -- 替换已有的路由
- ip route flush -- 替换已有的路由
- ip maddress -- 多播地址管理,
- ip mroute -- 多播路由缓存管理
- ip tunnel -- 通道配置
- ip monitor和rtmon -- 状态监视

## options

ip [OPTIONS] OBJECT [COMMAND [ARGUMENTS]]

OPTIONS是修改ip行为或改变其输出的选项。所有的选项都是以-字符开头，分为长、短两种形式。

OBJECT是要管理者获取信息的对象：
-V,-Version 打印ip的版本并退出。
-s,-stats,-statistics 输出更为详尽的信息。如果这个选项出现两次或多次，则输出的信息将更为详尽。
-f,-family 这个选项后面接协议种类，包括inet、inet6或link，强调使用的协议种类。如果没有足够的信息告诉ip使用的协议种类，ip就会使用默认值inet或any。link比较特殊，它表示不涉及任何网络协议。
-4 是-family inet的简写。
-6 是-family inet6的简写。
-0 是-family link的简写。
-o,-oneline 对每行记录都使用单行输出，回行用字符代替。如果需要使用wc、grep等工具处理ip的输出，则会用到这个选项。
-r,-resolve 查询域名解析系统，用获得的主机名代替主机IP地址
COMMAND 设置针对指定对象执行的操作，它和对象的类型有关。

一般情况下，ip支持对象的增加(add)、删除(delete)和展示(show或list)。
对于所有的对象，用户可以使用help命令获得帮助。
如果没有指定对象的操作命令，ip会使用默认的命令list，或者help命令。
ARGUMENTS 是命令的一些参数，它们倚赖于对象和命令。
ip支持两种类型的参数：flag和parameter。
flag由一个关键词组成；
parameter由一个 关键词加一个数值组成。
为了方便，每个命令都有一个可以忽略的默认参数。例如，参数dev是ip link命令的默认参数，因此ip link ls eth0等于ip link ls dev eth0。


## ip link show [ DEVICE ]

    # ip link set wlan down
    # ip link set eth0 name wlan            # rename interface
    # ip link set wlan up

# ifconfig

## list detail

    # ifconfig -a   # list all interface

    KVM-125 # sys ifconfig vlan125

    vlan125 Link encap:Ethernet  HWaddr 52:54:00:BD:0C:1C
            inet addr:192.168.17.125  Bcast:192.168.17.255  Mask:255.255.255.0
            UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
            RX packets:176 errors:0 dropped:0 overruns:0 frame:0
            TX packets:131 errors:0 dropped:0 overruns:0 carrier:0
            collisions:0 txqueuelen:1000
            RX bytes:13933 (13.6 KB)  TX bytes:15071 (14.7 KB)

    KVM-125 # dia netlink interface list | grep vlan125 -C6

      if=port_ha family=00 type=1 index=8 mtu=1496 link=0 master=0
      ref=11 state=off start present fw_flags=0 flags=up broadcast multicast

      if=vsys_fgfm family=00 type=772 index=9 mtu=16436 link=0 master=0
      ref=15 state=off start fw_flags=0 flags=up loopback run

      if=vlan125 family=00 type=1 index=11 mtu=1500 link=0 master=0
      ref=15 state=off start fw_flags=0 flags=up broadcast run multicast

## toggle a interface

    # ifconfig eth0 down
    # ifconfig eth0 up

## Assign ip-address

    # ifconfig eth0 192.168.2.2
    # ifconfig eth0 netmask 255.255.255.0
    # ifconfig eth0 broadcast 192.168.2.255
    # ifconfig eth0 mtu 1500

    # ifconfig eth0 192.168.2.2 netmask 255.255.255.0 broadcast 192.168.2.255

## promisc mode

By default when a network card receives a packet,
it checks whether the packet belongs to itself.
If not, the interface card normally drops the packet.
But in promiscuous mode, the card doesn’t drop the packet.
Instead, it will accept all the packets which flows through the network card.

Superuser privilege is required to set an interface in promiscuous mode. Most network monitor tools use the promiscuous mode to capture the packets and to analyze the network traffic.

    # ifconfig eth0 promisc     # put the interface in promiscuous mode
    # ifconfig eth0 -promisc    # put the interface in normal mode.

## ip addr

    # ip addr add 192.168.2.77/24 dev lan       #添加ip
    # ip addr show dev lan
    # ip addr flush dev lan                     #清空网卡的所有ip地址

<3>ip neigh
# ip neigh show	#显示ip与mac对应关系 
# ip neigh flush dev lan 

<4>ip route (需要开启ip_forward) 
# ip route	#相当于route -n 
# ip route add 192.168.2.0/24 via 192.168.1.1 dev lan	#添加一条路由：去往2.0网段，通过lan网卡，下一跳IP为192.168.1.1 
# ip route add 0.0.0.0/0 via 10.10.10.30 dev wan	#添加默认路由 
# ip route add default via 10.10.10.30 dev wan		#添加默认路由 
# ip route del 192.168.2.0/24 
# traceroute www.google.com	#路由追踪 
# tracepath www.google.com	#.. 
# mtr www.google.com		#动态刷新追踪 

------------------------------------------------------------------------------------------------------------ 
二、ECMP(Equal Cost Multipath等值多路径路由) 

当路由上有多个链路接入时，并且同时使用，可以考虑ECMP技术 
添加两个默认路由，使用rr调度算法根据会话轮询 
# ip route help		#查看帮助 
# ip route add default mpath rr nexthop via 192.168.96.254 dev vmnet1 nexthop via 192.168.203.254 dev vmnet8 
# ip route 		#这样就会有两条默认路由了

设置权重 
# ip route add default mpath rr nexthop via 192.168.96.254 dev vmnet1 weight 100 nexthop via 192.168.203.254 dev vmnet8 weight 10	#权重最大256 

默认RHEL5U3内核会cache路由，对于已经建立好的连接，不会轮询，而直接读取cache路由，从而破坏rr轮询，所以需要将“在cache情况下仍然支持ECMP的模块“编译出来安装 
Networking  --->  
--- Networking support 
Networking options  --->  
IP: equal cost multipath with caching support (EXPERIMENTAL) 


ip rule 
# ip route list table local	#最先查的表 
# ip route list table main	#平时操作的表 
# ip route list table default 


------------------------------------------------------------------------------------------------------------ 

三、策略路由 

1、基于源地址策略路由 

根据源客户端的子网网段走向相应的路由路径 
例如：销售部门和办公部门，让销售部门享受10M带宽线路，让办公部门享受1M带宽线路； 

配置举例： 
需求：让公司192.168.0.0/24网段的客户走网通路由，192.168.1.0/24网段的走电信路由； 

IP及拓扑说明：
C1--\   	/-----CNC\
     	(GW)         	> ---->Client3C2--/       \------TEL/ 

Client1：192.168.0.1	 
Client2：192.168.1.2 
Client3：20.0.0.1 

公司网关GW
对内：
I1:192.168.0.254	eth0
I2:192.168.1.254	eth0
对外：
E1:202.106.0.21		eth1
E2:202.106.46.152	eth1 
网通CNC网关
C1:202.106.0.20		eth0
C2:20.0.0.2		    	eth1
电信TEL网关
T1:202.106.46.151 	eth0
T2:20.0.0.3		         eth1 

GW配置： 
<1>增加自定义的路由表 
# vi /etc/iproute2/rt_tables  
100 	tab1 
101 	tab2
# ip rule 
<2>添加路由规则 
# ip route add default via 202.106.0.20 dev eth1 table tab1	#添加默认路由到表tab1 
# ip route add default via 202.106.46.151 dev eth1 table tab2	#添加默认路由到表tab2 
# ip rule add from 192.168.1.0/24 table tab1			#来自192.168.1.0/24网段的请求走tab1表 
# ip rule add from 192.168.0.0/24 table tab2 
# ip rule 
# ip route add 192.168.1.0/24 dev eth0 table tab1	#添加直连路由，若不添加则Client1 ping GW后，数据包不能返回，因为tab1表中只有一个default路由 
# ip route add 192.168.0.0/24 dev eth0 table tab2 

TEL配置：
添加去往Client1/2的路由 
# ip route add 192.168.0.0/24  via 202.106.46.152 dev eth0 
# ip route add 192.168.1.0/24  via 202.106.46.152 dev eth0 

CNC配置：
添加去往Client1/2的路由 
# ip route add 192.168.0.0/24  via 202.106.0.21 dev eth0 
# ip route add 192.168.1.0/24  via 202.106.0.21 dev eth0 

Client配置： 
Client1\2: 
# ip route add default via 192.168.0.254 dev eth0 
# ip route add default via 192.168.1.254 dev eth0 

Client3: 
# ip route add default via 20.0.0.3 dev eth0	#测试仅从TEL路径返回也可以双路返回 
# ip route add default mpath rr nexthop via 20.0.0.2 dev eth0 nexthop via 20.0.0.3 dev eth0 

Client1\2测试: 
# traceroute 20.0.0.1 

------------------------------------------------------------ 
2、基于防火墙标记的路由（firemark） 

将来自不同ip段的数据包打上不同的防火墙标记，根据防火墙的标记路由到相应的地址 
GW配置：
1-100的IP标记为1，101-253的IP标记为10 
# iptables -t mangle -A PREROUTING -m iprange --src-range 192.168.1.1-192.168.1.100 -j MARK --set-mark 1 
# iptables -t mangle -A PREROUTING -m iprange --src-range 192.168.1.101-192.168.1.253 -j MARK --set-mark 10 

先清空之前的rule 
# ip rule del from 192.168.1.0/24 
# ip rule del from 192.168.0.0/24 

# ip rule add fwmark 1 pref 1000 table tab1 	#将标记为1的包送至tab1，pref为优先级 
# ip rule add fwmark 10 pref 2000 table tab2 
# ip rule 
0:  	from all lookup 255  
1000:		....	tab1 
2000:		....	tab2 
32766:  from all lookup main  
32767:  from all lookup default  
剩余基本同上 
# ip route add default via 202.106.0.20 dev eth1 table tab1	#添加默认路由到表tab1 
# ip route add default via 202.106.46.151 dev eth1 table tab2 
# ip route add 192.168.1.0/24 dev eth0 table tab1		#添加直连路由 
# ip route add 192.168.0.0/24 dev eth0 table tab2 
........ 

------------------------------------------------------------ 
3、基于目的地址策略路由 
根据访问的目标地址返回，访问网通的IP段走CNC，访问电信的走TEL 

GW配置： 
删除规则 
# iptables -F -t mangle 
# ip rule del fwmark 1 pref 1000 table tab1 	 
# ip rule del fwmark 10 pref 2000 table tab2  

# ip rule add to 20.0.0.1 table tab2 
# ip rule add to 20.0.0.4 table tab1 
# ip rule 

其余配置同上 

Client1\2测试: 
# traceroute 20.0.0.1 
# traceroute 20.0.0.4 

假如访问教育网或国外网络，可以在main表中添加一条默认的路由


4.1 ip link set--改变设备的属性. 缩写：set、s

　　示例1：up/down 起动／关闭设备。
　　# ip link set dev eth0 up
　　这个等于传统的 # ifconfig eth0 up(down)

　　示例2：改变设备传输队列的长度。
　　参数:txqueuelen NUMBER或者txqlen NUMBER
　　# ip link set dev eth0 txqueuelen 100

　　示例3：改变网络设备MTU(最大传输单元)的值。
　　# ip link set dev eth0 mtu 1500

　　示例4： 修改网络设备的MAC地址。
　　参数: address LLADDRESS
　　# ip link set dev eth0 address 00:01:4f:00:15:f1

4.2 ip link show--显示设备属性. 缩写：show、list、lst、sh、ls、l
　　-s选项出现两次或者更多次，ip会输出更为详细的错误信息统计。

　　示例:
　　# ip -s -s link ls eth0
　　这个命令等于传统的 ifconfig eth0

5.1 ip address add--添加一个新的协议地址. 缩写：add、a

　　示例1：为每个地址设置一个字符串作为标签。为了和Linux-2.0的网络别名兼容，这个字符串必须以设备名开头，接着一个冒号，
　　# ip addr add local 192.168.4.1/28 brd + label eth0:1 dev eth0

　　示例2: 在以太网接口eth0上增加一个地址192.168.20.0，掩码长度为24位(155.155.155.0)，标准广播地址，标签为eth0:Alias：
　　# ip addr add 192.168.4.2/24 brd + dev eth1 label eth1:1
　　这个命令等于传统的: ifconfig eth1:1 192.168.4.2

5.2 ip address delete--删除一个协议地址. 缩写：delete、del、d
　　# ip addr del 192.168.4.1/24 brd + dev eth0 label eth0:Alias1

5.3 ip address show--显示协议地址. 缩写：show、list、lst、sh、ls、l
　　# ip addr ls eth0

5.4.ip address flush--清除协议地址. 缩写：flush、f
　　示例1 : 删除属于私网10.0.0.0/8的所有地址：
　　# ip -s -s a f to 10/8

　　示例2 : 取消以太网卡eth0的IPv4地址
　　# ip -4 addr flush label "eth0"

6. ip neighbour--neighbour/arp表管理命令
　　缩写 neighbour、neighbor、neigh、n
　　命令 add、change、replace、delete、fulsh、show(或者list)
　　缩写：add、a；change、chg；replace、repl

　　ip neighbour add -- 添加一个新的邻接条目
　　ip neighbour change--修改一个现有的条目
　　ip neighbour replace--替换一个已有的条目

　　示例1: 在设备eth0上，为地址10.0.0.3添加一个permanent ARP条目：
　　# ip neigh add 10.0.0.3 lladdr 0:0:0:0:0:1 dev eth0 nud perm

　　示例2:把状态改为reachable
　　# ip neigh chg 10.0.0.3 dev eth0 nud reachable

　　示例1:删除设备eth0上的一个ARP条目10.0.0.3
　　# ip neigh del 10.0.0.3 dev eth0

   ip neighbour show--显示网络邻居的信息. 缩写：show、list、sh、ls
　　示例1: # ip -s n ls 193.233.7.254
　　     193.233.7.254. dev eth0 lladdr 00:00:0c:76:3f:85 ref 5 used 12/13/20 nud reachable

　　ip neighbour flush--清除邻接条目. 缩写：flush、f
　　示例1: (-s 可以显示详细信息)
　　# ip -s -s n f 193.233.7.254

7. 路由表管理, 缩写 route、ro、r

　　内核把路由归纳到许多路由表中，这些表都进行了编号，编号数字的范围是1到255。另外，为了方便，还可以在/etc/iproute2/rt_tables中为路由表命名。
　　默认情况下，所有的路由都会被插入到表main(编号254)中。在进行路由查询时，内核只使用路由表main。

　　ip route add -- 添加新路由
　　ip route change -- 修改路由
　　ip route replace -- 替换已有的路由
　　    缩写：add、a；change、chg；replace、repl

　　示例0: 添加缺省路由
　　# ip route add default via 192.168.1.254
　　# ip route change default via 192.168.99.113

　　示例1: 设置到网络10.0.0/24的路由经过网关193.233.7.65
　　# ip route add 10.0.0/24 via 193.233.7.65

　　示例2: 修改到网络10.0.0/24的直接路由，使其经过设备dummy
　　# ip route chg 10.0.0/24 dev dummy

　　示例3: 实现链路负载平衡.加入缺省多路径路由，让ppp0和ppp1分担负载(注意：scope值并非必需，它只不过是告诉内核，这个路由要经过网关而不是直连的。实际上，如果你知道远程端点的地址，使用via参数来设置就更好了)。
　　# ip route add default scope global nexthop dev ppp0 nexthop dev ppp1
　　# ip route replace default scope global nexthop dev ppp0 nexthop dev ppp1

　　示例4: 设置NAT路由。在转发来自192.203.80.144的数据包之前，先进行网络地址转换，把这个地址转换为193.233.7.83
　　# ip route add nat 192.203.80.142 via 193.233.7.83

　　示例5: 实现数据包级负载平衡,允许把数据包随机从多个路由发出。weight 可以设置权重.
   # ip route replace default equalize nexthop via 211.139.218.145 dev eth0 weight 1 nexthop via 211.139.218.145 dev eth1 weight 1

　　ip route delete-- 删除路由, 缩写：delete、del、d

　　示例1:删除上一节命令加入的多路径路由
　　# ip route del default scope global nexthop dev ppp0 nexthop dev ppp1

　　ip route show -- 列出路由, 缩写：show、list、sh、ls、l
　　示例1: 计算使用gated/bgp协议的路由个数
　　# ip route ls proto gated/bgp |wc

　　示例2: 计算路由缓存里面的条数，由于被缓存路由的属性可能大于一行，以此需要使用-o选项
　　# ip -o route ls cloned |wc

　　示例3: 列出路由表TABLEID里面的路由。缺省设置是table main。TABLEID或者是一个真正的路由表ID或者是/etc/iproute2/rt_tables文件定义的字符串，
　　或者是以下的特殊值：
	　　all -- 列出所有表的路由；
	　　cache -- 列出路由缓存的内容。
　　        ip ro ls 193.233.7.82 tab cache

　　示例4: 列出某个路由表的内容
　　# ip route ls table fddi153

　　示例5: 列出默认路由表的内容
　　# ip route ls
　　这个命令等于传统的: route

　　ip route flush -- 擦除路由表

　　示例1: 删除路由表main中的所有网关路由（示例：在路由监控程序挂掉之后）：
　　# ip -4 ro flush scope global type unicast

　　示例2:清除所有被克隆出来的IPv6路由：
　　# ip -6 -s -s ro flush cache

　　示例3: 在gated程序挂掉之后，清除所有的BGP路由：
　　# ip -s ro f proto gated/bgp

　　示例4: 清除所有ipv4路由cache
　　# ip route flush cache

　　ip route get -- 获得单个路由 .缩写：get、g
　　使用这个命令可以获得到达目的地址的一个路由以及它的确切内容。
　　ip route get命令和ip route show命令执行的操作是不同的。
　　ip route show命令只是显示现有的路由，而ip route get命令在必要时会派生出新的路由。

　　示例1: 搜索到193.233.7.82的路由
　　# ip route get 193.233.7.82
　　    193.233.7.82 dev eth0 src 193.233.7.65 realms inr.ac cache mtu 1500 rtt 300

　　示例2: 搜索目的地址是193.233.7.82，来自193.233.7.82，从eth0设备到达的路由（这条命令会产生一条非常有意思的路由，这是一条到193.233.7.82的回环路由）
　　# ip r g 193.233.7.82 from 193.233.7.82 iif eth0
　　    193.233.7.82 from 193.233.7.82 dev eth0 src 193.233.7.65 realms inr.ac/inr.ac
　　    cache <src-direct,redirect> mtu 1500 rtt 300 iif eth0

8. ip route -- 路由策略数据库管理命令

　　add、delete、show(或者list)
　　注意：策略路由(policy routing)不等于路由策略(rouing policy)。
　　在某些情况下，我们不只是需要通过数据包的目的地址决定路由，可能还需要通过其他一些域：源地址、IP协议、传输层端口甚至数据包的负载。
　　这就叫做：策略路由(policy routing)。

   ip rule add -- 插入新的规则
   ip rule delete -- 删除规则
　　缩写：add、a；delete、del、d

　　示例1: 通过路由表inr.ruhep路由来自源地址为192.203.80/24的数据包
　　ip ru add from 192.203.80/24 table inr.ruhep prio 220

　　示例2:把源地址为193.233.7.83的数据报的源地址转换为192.203.80.144，并通过表1进行路由
　　ip ru add from 193.233.7.83 nat 192.203.80.144 table 1 prio 320

　　示例3:删除无用的缺省规则
　　ip ru del prio 32767

　　ip rule show -- 列出路由规则, 缩写：show、list、sh、ls、l

　　示例1: # ip ru ls
	　　0: from all lookup local
	　　32762: from 192.168.4.89 lookup fddi153
	　　32764: from 192.168.4.88 lookup fddi153
	　　32766: from all lookup main
	　　32767: from all lookup 253

9. ip maddress -- 多播地址管理, 缩写：show、list、sh、ls、l

　　ip maddress show -- 列出多播地址
　　示例1: # ip maddr ls dummy

　　ip maddress add -- 加入多播地址
　　ip maddress delete -- 删除多播地址, 缩写：add、a；delete、del、d
　　使用这两个命令，我们可以添加／删除在网络接口上监听的链路层多播地址。这个命令只能管理链路层地址。

　　示例1: 增加 # ip maddr add 33:33:00:00:00:01 dev dummy
　　示例2: 查看 # ip -O maddr ls dummy
	　　2: dummy
	　　link 33:33:00:00:00:01 users 2 static
	　　link 01:00:5e:00:00:01

　　示例3: 删除 
　　# ip maddr del 33:33:00:00:00:01 dev dummy
　　
10.ip mroute -- 多播路由缓存管理

　　ip mroute show -- 列出多播路由缓存条目, 缩写：show、list、sh、ls、l

　　示例1:查看 # ip mroute ls
	　　(193.232.127.6, 224.0.1.39) Iif: unresolved
	　　(193.232.244.34, 224.0.1.40) Iif: unresolved
	　　(193.233.7.65, 224.66.66.66) Iif: eth0 Oifs: pimreg

　　示例2:查看 
　　# ip -s mr ls 224.66/16

11. ip tunnel -- 通道配置, 缩写tunnel、tunl

　　ip tunnel add -- 添加新的通道
　　ip tunnel change -- 修改现有的通道
　　ip tunnel delete -- 删除一个通道
　　缩写：add、a；change、chg；delete、del、d

　　示例1:建立一个点对点通道，最大TTL是32
　　# ip tunnel add Cisco mode sit remote 192.31.7.104 local 192.203.80.1 ttl 32
　　ip tunnel show -- 列出现有的通道, 缩写：show、list、sh、ls、l
　　示例1: # ip -s tunl ls Cisco

12. ip monitor和rtmon -- 状态监视
　　ip命令可以用于连续地监视设备、地址和路由的状态。这个命令选项的格式有点不同，命令选项的名字叫做monitor，接着是操作对象：

　　ip monitor [ file FILE ] [ all | OBJECT-LIST ]
　　示例1: # rtmon file /var/log/rtmon.log
　　示例2: # ip monitor file /var/log/rtmon.log r





## vlan

    $ sudo ip link add link eth0 name vlan125 type vlan id 125
    $ sudo ip addr add 192.168.17.122/24 dev vlan125
    $ sudo ip route change default via 192.168.17.125
    $ ip route list
    $ ping 192.168.17.125
    $ ping 8.8.8.8


  [1]: http://www.cyberciti.biz/files/ss.html
  [2]: http://www.binarytides.com/linux-ss-command/
  [6]: https://networkengineering.stackexchange.com/questions/14965/icmp-redirect-static-routing
